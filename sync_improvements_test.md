# 邮件同步改进测试指南

## 改进内容

### 1. 收藏/笔记邮件优先级 ✅
- **问题**：之前收藏或有笔记的邮件可能被白名单过滤掉
- **解决方案**：
  - 先进行白名单筛选
  - 找出被过滤但有用户操作的重要邮件
  - 将重要邮件重新加入最终结果
  - 确保收藏和有笔记的邮件永远不会丢失

### 2. 同步动画和进度提示 ✅
- **同步进度对话框**：显示当前同步的账户和进度
- **旋转动画**：同步按钮在同步时会旋转
- **进度条**：显示同步进度 (当前账户/总账户数)
- **状态提示**：显示当前正在同步的账户名称
- **完成提示**：同步完成后显示邮件数量

## 测试步骤

### 测试1：收藏邮件优先级
1. 收藏几封来自非白名单发件人的邮件
2. 在设置中配置严格的白名单规则
3. 清理缓存并重新同步
4. **预期结果**：收藏的邮件应该仍然存在，不会被白名单过滤

### 测试2：笔记邮件优先级
1. 给几封来自非白名单发件人的邮件添加笔记
2. 在设置中配置严格的白名单规则
3. 清理缓存并重新同步
4. **预期结果**：有笔记的邮件应该仍然存在，不会被白名单过滤

### 测试3：同步动画效果
1. 点击同步按钮（浮动操作按钮）
2. **预期结果**：
   - 按钮开始旋转动画
   - 显示同步进度对话框
   - 对话框显示当前同步的账户名称
   - 显示进度条和数字进度
   - 同步完成后对话框消失
   - 显示绿色的完成提示，包含邮件数量

### 测试4：下拉刷新动画
1. 在邮件列表页面下拉刷新
2. **预期结果**：
   - 显示同步进度对话框
   - 同步完成后显示成功提示

## 技术实现细节

### 优先级筛选逻辑
```dart
// 1. 先白名单筛选
final whitelistFiltered = await _whitelistService.filterEmails(emails);

// 2. 找出被过滤但重要的邮件
final importantFiltered = filteredOut.where((email) {
  final userData = userDataMap[email.messageId];
  return userData?.isStarred == true || 
         (userData?.notes?.isNotEmpty == true);
});

// 3. 合并结果
final finalEmails = [...whitelistFiltered, ...importantFiltered];
```

### 动画实现
- 使用 `AnimationController` 控制旋转动画
- 使用 `StatefulBuilder` 更新进度对话框
- 使用 `CircularProgressIndicator` 显示进度
- 使用 `Transform.rotate` 实现按钮旋转效果